// api-monitor.js â€” Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª API ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
(function() {
    'use strict';

    console.log("[ðŸ” API Monitor] Started. Logging all XHR/Fetch requests...");

    // 1. Ø§Ø¹ØªØ±Ø§Ø¶ Ø·Ù„Ø¨Ø§Øª fetch
    const originalFetch = window.fetch;
    window.fetch = async (...args) => {
        const [url, options = {}] = args;
        const method = (options.method || 'GET').toUpperCase();
        const headers = options.headers || {};
        const body = options.body ? (typeof options.body === 'string' ? options.body.substring(0, 200) : '[Non-string body]') : null;

        console.log(`[ðŸ“¡ FETCH] ${method} ${url}`);
        if (Object.keys(headers).length > 0) console.log(`  Headers:`, headers);
        if (body) console.log(`  Body (truncated):`, body);

        return originalFetch.apply(this, args);
    };

    // 2. Ø§Ø¹ØªØ±Ø§Ø¶ Ø·Ù„Ø¨Ø§Øª XMLHttpRequest
    const originalOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(method, url) {
        this._url = url;
        this._method = method;
        return originalOpen.apply(this, arguments);
    };

    const originalSend = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.send = function(body) {
        console.log(`[ðŸ“¡ XHR] ${this._method || 'UNKNOWN'} ${this._url}`);
        if (body) console.log(`  Body (truncated):`, (typeof body === 'string' ? body.substring(0, 200) : '[Non-string body]'));

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø¤ÙˆØ³ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        const headers = {};
        const setRequestHeader = this.setRequestHeader;
        this.setRequestHeader = function(name, value) {
            headers[name] = value;
            return setRequestHeader.apply(this, arguments);
        };

        // Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø£Ø¹Ø¯ ØªØ¹ÙŠÙŠÙ† setRequestHeader (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        const originalOnReadyStateChange = this.onreadystatechange;
        this.onreadystatechange = function() {
            if (this.readyState === 4) {
                if (Object.keys(headers).length > 0) {
                    console.log(`  Headers sent:`, headers);
                }
            }
            if (originalOnReadyStateChange) originalOnReadyStateChange.apply(this, arguments);
        };

        return originalSend.apply(this, arguments);
    };

    console.log("[âœ…] API Monitor is active. Refresh the page to capture initial requests.");
})();
